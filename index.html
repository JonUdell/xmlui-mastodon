<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="xmlui/0.9.13.js"></script>
  <script src="xmlui/charts-0.1.12.js"></script>
  <script src="config.js"></script>
  <!-- <script src="scripts/followers.js"></script> -->
  <script>

    window.init = function () {
      sql = `select steampipe_configure_mastodon('access_token="${window.config.mastodonToken}"
    server="${window.config.server}"
    app="${window.config.app}"')`
      console.log(sql)
      return { sql: sql }
    }

    window.query = 'http://localhost:8080/query'

    window.updateQueryWithNonce = function (query, appStateUpdateFn) {
      console.log('Executing query:', query);
      // Get the raw query without any existing nonce comment
      const rawQuery = query.replace(/^-- [0-9]+\n\n/, '');
      // Add nonce comment at the beginning
      const queryWithNonce = `-- ${Date.now()}\n\n${rawQuery}`;
      console.log('Modified query with nonce:', queryWithNonce);

      // Update the app state
      appStateUpdateFn({
        example: queryWithNonce,
        loading: true,
        results: []
      });

      return queryWithNonce;
    }

    // Custom SQL query function
    window.customSql = function (query) {
      console.log('Running query:', query);
      return {
        sql: query
      }
    }

    // Cache for usernames to avoid duplicate queries
    window.usernameCache = {};

    window.tootsHome = function (count) {
      return {
        sql: `
            select
                id,
                username,
                display_name,
                created_at,
                url,
                instance_qualified_url,
                status,
                reblog,
                json_extract(status, '$.content') as content,
                cast(json_extract(status, '$.replies_count') as integer) as replies_count,
                cast(json_extract(status, '$.reblogs_count') as integer) as reblogs_count,
                cast(json_extract(status, '$.favourites_count') as integer) as favourites_count,
                json_extract(account, '$.avatar') as avatar_url,
                json_extract(account, '$.header') as header_url,
                json_extract(account, '$.note') as note,
                json_extract(account, '$.followers_count') as followers_count,
                json_extract(account, '$.following_count') as following_count,
                json_extract(account, '$.statuses_count') as statuses_count,
                case
                  when reblog is not null then json_extract(reblog, '$.account.avatar')
                  else null
                end as reblog_avatar_url,
                case
                  when reblog is not null then json_extract(reblog, '$.account.header')
                  else null
                end as reblog_header_url,
                case
                  when reblog is not null then json_extract(reblog, '$.account.note')
                  else null
                end as reblog_note,
                case
                  when reblog is not null then json_extract(reblog, '$.account.followers_count')
                  else null
                end as reblog_followers_count,
                case
                  when reblog is not null then json_extract(reblog, '$.account.following_count')
                  else null
                end as reblog_following_count,
                case
                  when reblog is not null then json_extract(reblog, '$.account.statuses_count')
                  else null
                end as reblog_statuses_count,
                case
                  when reblog is not null then json_extract(reblog, '$.account.display_name')
                  else null
                end as reblog_display_name,
                case
                  when reblog is not null then json_extract(reblog, '$.account.username')
                  else null
                end as reblog_username,
                case
                  when reblog is not null then json_extract(reblog, '$.content')
                  else null
                end as reblog_content,
                case
                  when reblog is not null then json_extract(reblog, '$.created_at')
                  else null
                end as reblog_created_at,
                case
                  when reblog is not null then json_extract(reblog, '$.account.url')
                  else null
                end as reblog_account_url,
                json_extract(status, '$.in_reply_to_id') as in_reply_to_id,
                json_extract(status, '$.in_reply_to_account_id') as in_reply_to_account_id
            from mastodon_toot_home
            order by created_at desc
            limit ${count}
            `
          }
    }

    window.formatDate = function (dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        return date.toLocaleString();
      } catch (e) {
        return dateString || '';
      }
    }

    window.formatShortDate = function (dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString();
      } catch (e) {
        return dateString || '';
      }
    }

    window.getCount = function (obj, property) {
      if (!obj || !property) return 0;
      const value = obj[property];
      if (value === undefined || value === null) return 0;

      // Try to convert to number, return 0 if it fails
      const num = parseInt(value, 10);
      return isNaN(num) ? 0 : num;
    }

    // Function to look up a username from an account ID - used by tootsHome
    window.lookupUsername = function (accountId) {
      if (!accountId) return null;

      // Return from cache if available
      if (window.usernameCache[accountId]) {
        return { username: window.usernameCache[accountId] };
      }

      return {
        sql: `SELECT username FROM mastodon_account WHERE id = '${accountId}'`,
        then: function (result) {
          if (result && result.length > 0) {
            // Store username in cache for future use
            window.usernameCache[accountId] = result[0].username;
            return { username: result[0].username };
          }
          return { username: null };
        }
      };
    }

    window.followers = function () {
      return {
        sql: `
          select
            account_id,
            id,
            acct,
            created_at,
            url,
            instance_qualified_account_url,
            username,
            server,
            display_name,
            followers_count,
            following_count,
            statuses_count,
            note,
            json_extract(account, '$.avatar') as avatar_url
          from follower
          order by created_at desc
        `
      }
    }

    window.following = function () {
      return {
        sql: `
          select
            account_id,
            id,
            acct,
            created_at,
            url,
            instance_qualified_account_url,
            username,
            server,
            display_name,
            followers_count,
            following_count,
            statuses_count,
            note,
            json_extract(account, '$.avatar') as avatar_url
          from follow
          order by created_at desc
        `
      }
    }


  </script>
</head>

<body>
</body>

</html>