<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="xmlui/0.9.13.js"></script>
    <script src="xmlui/charts-0.1.12.js"></script>
    <script src="config.js"></script>
    <script>
        window.pipesQuery = 'http://localhost:8080/proxy/pipes.turbot.com/api/latest/user/jonudell/workspace/mastodon/query'

        window.windowValue = 0;

        window.init = function () {
            return { sql: `select steampipe_configure_github('token="${window.config.githubToken}"')` }
        }

        window.updateQueryWithNonce = function(query, appStateUpdateFn) {
            console.log('Executing query:', query);
            // Get the raw query without any existing nonce comment
            const rawQuery = query.replace(/^-- [0-9]+\n\n/, '');
            // Add nonce comment at the beginning
            const queryWithNonce = `-- ${Date.now()}\n\n${rawQuery}`;
            console.log('Modified query with nonce:', queryWithNonce);

            // Update the app state
            appStateUpdateFn({
                example: queryWithNonce,
                loading: true,
                results: []
            });

            return queryWithNonce;
        }

        // Custom SQL query function
        window.customSql = function(query) {
            console.log('Running query:', query);
            return {
                sql: query
            }
        }

        window.tootsHome = function (count) {
            return {
                sql: `select
                    id,
                    username,
                    display_name,
                    created_at,
                    url,
                    instance_qualified_url,
                    status,
                    reblog,
                    (status->>'replies_count')::int as replies_count,
                    (status->>'reblogs_count')::int as reblogs_count,
                    (status->>'favourites_count')::int as favourites_count
                from mastodon_toot_home
                order by created_at desc
                limit ${count}
              `}
        }

        window.formatDate = function(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleString();
            } catch (e) {
                return dateString;
            }
        }

        window.getCount = function(obj, property) {
            if (!obj || !property) return 0;
            const value = obj[property];
            if (value === undefined || value === null) return 0;

            // Try to convert to number, return 0 if it fails
            const num = parseInt(value, 10);
            return isNaN(num) ? 0 : num;
        }

    </script>
</head>

<body>
</body>

</html>